<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="bootstrap.min.css">
    <style>
        .invisible {
            position: absolute;
            left: -9999px;
        }
    </style>
    <title>Kayit-revize-rapor uygulaması</title>
</head>
<body>
    <ul class="nav nav-tabs">
        <li class="nav-item" id="tab1">
          <a class="nav-link active">Kayıt</a>
        </li>
        <li class="nav-item" id="tab2">
          <a class="nav-link">Revize</a>
        </li>
        <li class="nav-item" id="tab3">
          <a class="nav-link">Rapor</a>
        </li>
    </ul>
    <div id="liveAlertPlaceholder"></div>
    <div id="ekran1">
        <div class="m-3">
            <label for="formFile" class="form-label" style="font-weight: bold;">Çoklu kayıt</label>
            <input class="form-control" type="file" id="formFile">
        </div>      
        <div class="m-3">
            <label for="formFile" class="form-label" style="font-weight: bold;">Tek kayıt</label>
            <div>
                <div class="input-group mb-2">
                    <span class="input-group-text" id="basic-addon1">T.C. Kimlik No:</span>
                    <input type="text" class="form-control" aria-label="Username" aria-describedby="basic-addon1" id="tcno">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text" id="basic-addon1">İsim-soyisim:</span>
                    <input type="text" class="form-control" aria-label="Username" aria-describedby="basic-addon1" id="isim_soyisim">
                </div>
            </div>
            <div id="tekli">
                <div class="form-check invisible" id="model">
                    <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">
                    <label class="form-check-label" for="flexCheckDefault" id="labol">
                    Default checkbox
                    </label>
                </div>
            </div>
            <button type="button" class="btn btn-primary mt-3" id="kaydet">Kaydet</button>
        </div>  
    </div>
    <div class="m-3 invisible" id="ekran2">
        <div class="input-group mb-2">
            <span class="input-group-text" >T.C. Kimlik no:</span>
            <input type="text" id="tcnorev" class="form-control" placeholder="T.C. kimlik no giriniz" aria-label="Username" aria-describedby="basic-addon1">
        </div>
        <div class="input-group mb-2">
            <span class="input-group-text" >İsim-soyisim:</span>
            <input type="text" id="isimrev" class="form-control" disabled="true" aria-label="Username" aria-describedby="basic-addon1">
        </div>
        <div class="input-group mb-2">
            <span class="input-group-text" >Kartid:</span>
            <input type="text" id="kartidrev" class="form-control" disabled="true" aria-label="Username" aria-describedby="basic-addon1">
        </div>
        <div id="rolliste">
        </div>
        <button type="button" class="btn btn-primary mt-3" id="update">Güncelle</button>
    </div>
    <div class="m-3 invisible" id="ekran3">
    </div>
    <script>
        const {ipcRenderer} = require('electron');
        const finput = document.querySelector("#formFile");
        const check_model = document.querySelector("#model");
        const tekli = document.querySelector("#tekli");
        const rolliste = document.querySelector("#ekran2 > #rolliste");
        const kaydet = document.querySelector("#kaydet");
        const kartidrev = document.querySelector("#kartidrev");
        let tcnorev = document.querySelector("#tcnorev");
        const isimsoy = document.querySelector("#isimrev");
        const revizebuton = document.querySelector("#update");
        const tabbuttons =  [ document.querySelector("#tab1"), document.querySelector("#tab2"), document.querySelector("#tab3") ];
        let roller_dizisi = [];
        let currentTab = 1;

        // Bu alert metodunu https://getbootstrap.com/docs/5.3/components/alerts/#examples'den aldım ama biraz değiştirdim
        const alertPlaceholder = document.getElementById('liveAlertPlaceholder')
        const alertb = (message, type) => {
            const wrapper = document.createElement('div')
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible" role="alert">`,
                `   <div>${message}</div>`,
                `   <button type="button" onclick="this.parentElement.classList.add('invisible')" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`,
                '</div>'
            ].join('')

            alertPlaceholder.append(wrapper)
        }
        //

        for(let i = 0; i < tabbuttons.length; i++) {
            tabbuttons[i].addEventListener('click', ()=>{
                if(i == 1) {
                    rolliste.innerHTML = "";
                    for(let i = 0; i < roller_dizisi.length; i++) {
                        let a = check_model.cloneNode(true);
                        a.className = "form-check";
                        a.querySelector(":scope > #labol").textContent = roller_dizisi[i];
                        rolliste.appendChild(a);
                    }
                }
                let fromtab = document.querySelector("#ekran"+currentTab);
                fromtab.classList.add("invisible");
                document.querySelector("#ekran"+(i+1)).classList.remove("invisible");
                tabbuttons[currentTab-1].querySelector(":scope > a").classList.remove("active");
                tabbuttons[i].querySelector(":scope > a").classList.add("active");
                currentTab = i+1;
            })
        }
        ipcRenderer.invoke('roller').then((v)=>{
            roller_dizisi = v;
            for(let i = 0; i < roller_dizisi.length; i++) {
                let a = check_model.cloneNode(true);
                a.className = "form-check";
                a.querySelector(":scope > #labol").textContent = roller_dizisi[i];
                tekli.appendChild(a);
            }
        })
        
        kaydet.addEventListener('click',()=>{
            let isimsoyi = document.querySelector("#isim_soyisim").value;
            let tckno = document.querySelector("#tcno").value;
            let roller = [];
            for(let i = 1; i < tekli.childElementCount; i++) {
                if(tekli.children[i].querySelector(":scope > #flexCheckDefault").checked) {
                    roller.push(i-1);
                }
            }
            ipcRenderer.invoke('kayit', {
                tc: parseInt(tckno),
                isimsoyisim:isimsoyi,
                roller:roller.join(',')
            }).then((v)=>{
                alertb(v, 'success');
            }).catch((err)=>{
                if(err) {
                    alertb(err, 'danger')
                    console.error(err);
                }
            })
        })

        finput.addEventListener('change',()=>{
            let val = finput.files[0].path;
            ipcRenderer.invoke('coklu-kayit', val).then((v)=>{
                alertb("İşlem başarıyla tamamlandı!", 'success')
            }).catch((err)=>{
                if(err) {
                    alertb("HATA: " + err, 'danger')
                    console.error(err);
                }
            })
        })

        tcnorev.addEventListener("change", ()=>{
            let val = tcnorev.value;
            ipcRenderer.invoke('get-user', parseInt(val)).then((v)=>{
                isimsoy.value = v.isim_soyisim;
                kartidrev.value = v.kartid;
                let rollerimiz = v.roller.split(',');
                for(let i = 0; i < rollerimiz.length; i++) {
                    let chckbx = rolliste.children[parseInt(rollerimiz[i])];
                    chckbx.querySelector(":scope > #flexCheckDefault").checked = true;
                }
            }).catch((err)=>{
                if(err) {
                    console.error(err);
                }
            })
        })
        revizebuton.addEventListener('click', ()=>{
            if(!tcnorev.value || isNaN(parseInt(tcnorev.value))) {
                alertb("Girilen bilgiler hatalı veya eksik", 'danger')
                return;
            }
            let roller = [];
            for(let j = 0; j < roller_dizisi.length; j++) {
                if(rolliste.children[j].querySelector(":scope > #flexCheckDefault").checked) {
                    roller.push(j);
                }
            }
            ipcRenderer.invoke('revize', parseInt(tcnorev.value), roller.join(',')).then((v)=>{
                alertb(v, 'success');
            }).catch((err)=>{
                if(err) {
                    alertb(err, 'danger');
                    console.error(err);
                }
            })
        })
    </script>
</body>
</html>